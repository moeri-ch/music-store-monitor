name: ðŸŽ¸ Multi-Store Music Monitor (Daily)

on:
  schedule:
    # æ¯Žæ—¥ æ—¥æœ¬æ™‚é–“8:00 (UTC 23:00) ã«å®Ÿè¡Œ
    - cron: '0 23 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ðŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸ” Debug environment
      run: |
        echo "Python version:"
        python --version
        echo "pip list:"
        pip list
        echo "Current directory:"
        pwd
        echo "Files in directory:"
        ls -la
        echo "Environment variables:"
        env | grep -E "(SMTP|EMAIL)" || echo "No email environment variables found"

    - name: ðŸ” Run Multi-Store Monitor
      env:
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        GITHUB_ACTIONS: true
      run: |
        echo "Starting music store monitor..."
        python -u music_store_monitor.py
      continue-on-error: true

    - name: ðŸ“‹ Check created files
      if: always()
      run: |
        echo "Files after execution:"
        ls -la
        echo "Log file content (if exists):"
        if [ -f "multi_store_monitor_price_required.log" ]; then
          cat multi_store_monitor_price_required.log
        else
          echo "Log file not found"
        fi
        echo "JSON file content (if exists):"
        if [ -f "multi_store_products_price_required.json" ]; then
          head -20 multi_store_products_price_required.json
        else
          echo "JSON file not found"
        fi

    - name: ðŸ“Š Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitor-logs
        path: |
          *.log
          *.json
        retention-days: 30
        if-no-files-found: ignore

    - name: ðŸ“ˆ Create summary
      if: always()
      run: |
        echo "## ðŸŽ¸ Multi-Store Monitor Results" >> $GITHUB_STEP_SUMMARY
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "å®Ÿè¡Œç’°å¢ƒ: GitHub Actions" >> $GITHUB_STEP_SUMMARY
        echo "å®Ÿè¡Œé »åº¦: æ¯Žæ—¥ æ—¥æœ¬æ™‚é–“8:00" >> $GITHUB_STEP_SUMMARY
        echo "å¯¾è±¡ã‚µã‚¤ãƒˆ: ã‚¤ã‚±ãƒ™æ¥½å™¨åº—ã€é»’æ¾¤æ¥½å™¨åº—ã€å³¶æ‘æ¥½å™¨ã€QSicã€J-Guitar" >> $GITHUB_STEP_SUMMARY
        echo "ä¾¡æ ¼åˆ¶é™: 10ä¸‡å††ä»¥ä¸Šã®ã¿é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "multi_store_monitor_price_required.log" ]; then
          echo "### ðŸ“‹ å®Ÿè¡Œãƒ­ã‚° (æœ€æ–°10è¡Œ)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -10 multi_store_monitor_price_required.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi