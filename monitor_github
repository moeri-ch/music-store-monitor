#!/usr/bin/env python3
"""
GitHub Actionsç”¨æ¥½å™¨åº—å•†å“ç›£è¦–ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
"""

import requests
from bs4 import BeautifulSoup
import json
import smtplib
import re
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime
import logging
import os
import sys

class GitHubMusicStoreMonitor:
    def __init__(self):
        """GitHub Actionsç’°å¢ƒç”¨ã®åˆæœŸåŒ–"""
        self.url = "https://www.ikebe-gakki.com/Form/Product/ProductList.aspx?shop=0&cat=agt003&bid=ec&dpcnt=20&img=1&sort=07&udns=1&fpfl=0&sfl=0&pno=1"
        self.data_file = 'products_data.json'
        self.config = self.load_config()
        self.setup_logging()
        
    def load_config(self):
        """è¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿"""
        # GitHub Actionsã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã¿
        if os.getenv('GITHUB_ACTIONS'):
            print("ğŸ”§ GitHub Actionsç’°å¢ƒã§å®Ÿè¡Œä¸­")
            return {
                "email": {
                    "smtp_server": os.getenv('SMTP_SERVER', 'smtp.gmail.com'),
                    "smtp_port": int(os.getenv('SMTP_PORT', 587)),
                    "sender_email": os.getenv('SENDER_EMAIL'),
                    "sender_password": os.getenv('SENDER_PASSWORD'),
                    "recipient_email": os.getenv('RECIPIENT_EMAIL')
                }
            }
        else:
            # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯config.jsonã‹ã‚‰èª­ã¿è¾¼ã¿
            try:
                with open('config.json', 'r', encoding='utf-8') as f:
                    return json.load(f)
            except FileNotFoundError:
                print("âŒ config.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                sys.exit(1)
    
    def setup_logging(self):
        """ãƒ­ã‚°è¨­å®šï¼ˆGitHub Actionsç”¨ï¼‰"""
        # GitHub Actionsã§ã¯æ¨™æº–å‡ºåŠ›ã«å‡ºåŠ›
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.StreamHandler(sys.stdout),
                logging.FileHandler('music_store_monitor.log', encoding='utf-8')
            ]
        )
        self.logger = logging.getLogger(__name__)
        
        # GitHub Actionsç”¨ã®ç‰¹åˆ¥ãªå‡ºåŠ›
        if os.getenv('GITHUB_ACTIONS'):
            self.logger.info("ğŸš€ GitHub Actions ã§æ¥½å™¨åº—å•†å“ç›£è¦–ã‚’é–‹å§‹")
    
    def get_products(self):
        """å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
            
            self.logger.info(f"ğŸ” å•†å“ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹: {self.url}")
            response = requests.get(self.url, headers=headers, timeout=30)
            response.encoding = 'utf-8'
            
            if response.status_code != 200:
                self.logger.error(f"HTTPã‚¨ãƒ©ãƒ¼: {response.status_code}")
                return []
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # å•†å“ãƒªãƒ³ã‚¯ã‚’æŠ½å‡º
            product_links = self.extract_product_links(soup)
            
            # å„å•†å“ãƒªãƒ³ã‚¯ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºï¼ˆæœ‰åŠ¹ãªå•†å“ã®ã¿ï¼‰
            products = []
            for link_info in product_links:
                try:
                    product = self.parse_product_info(link_info)
                    if product and self.is_valid_product(product):
                        products.append(product)
                        self.logger.debug(f"æœ‰åŠ¹ãªå•†å“ã‚’è¿½åŠ : {product['name']}")
                    else:
                        self.logger.debug(f"ç„¡åŠ¹ãªå•†å“ã‚’é™¤å¤–: {link_info.get('text', 'N/A')}")
                        
                except Exception as e:
                    self.logger.warning(f"å•†å“è§£æã‚¨ãƒ©ãƒ¼: {e}")
                    continue
            
            self.logger.info(f"âœ… æœ‰åŠ¹ãªå•†å“æ•°: {len(products)}")
            if len(product_links) > len(products):
                excluded_count = len(product_links) - len(products)
                self.logger.info(f"ğŸš« é™¤å¤–ã•ã‚ŒãŸç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿: {excluded_count}ä»¶")
            
            return products
            
        except Exception as e:
            self.logger.error(f"å•†å“å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def extract_product_links(self, soup):
        """å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã®ã¿ã‚’æŠ½å‡º"""
        product_links = []
        all_links = soup.find_all('a', href=True)
        
        for link in all_links:
            href = link.get('href', '')
            text = link.get_text(strip=True)
            
            if self.is_product_link(href, text):
                price_info = self.find_nearby_price(link)
                link_info = {
                    'element': link,
                    'href': href,
                    'text': text,
                    'price_nearby': price_info
                }
                product_links.append(link_info)
        
        self.logger.info(f"ğŸ“¦ å•†å“ãƒªãƒ³ã‚¯å€™è£œ: {len(product_links)}ä»¶")
        return product_links
    
    def is_product_link(self, href, text):
        """å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
        product_indicators = ['pid=', '/detail', 'ProductDetail', '/item/']
        exclude_indicators = [
            'javascript:', 'mailto:', '#', '/search', '/category', '/cart',
            '/login', '/register', '/help', '/contact', '/company', '/privacy',
            'facebook.com', 'twitter.com', 'instagram.com', 'youtube.com',
            'sort=', 'page=', 'pno=', 'img=', 'dpcnt=',
        ]
        
        href_lower = href.lower()
        for exclude in exclude_indicators:
            if exclude in href_lower:
                return False
        
        for indicator in product_indicators:
            if indicator in href_lower:
                return True
        
        if text and len(text) > 1:
            instrument_brands = ['yamaha', 'fender', 'gibson', 'martin', 'taylor', 'hernandez', 'yacopi', 'yairi']
            if any(brand in text.lower() for brand in instrument_brands):
                if href.startswith('/') or 'ikebe-gakki.com' in href:
                    return True
        
        return False
    
    def find_nearby_price(self, link_element):
        """ãƒªãƒ³ã‚¯è¦ç´ ã®è¿‘ãã«ã‚ã‚‹ä¾¡æ ¼æƒ…å ±ã‚’å–å¾—"""
        current = link_element.parent
        for _ in range(3):
            if current is None:
                break
            price_text = current.get_text()
            price_match = self.extract_price_from_text(price_text)
            if price_match:
                return price_match
            current = current.parent
        return None
    
    def extract_price_from_text(self, text):
        """ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä¾¡æ ¼ã‚’æŠ½å‡º"""
        price_patterns = [
            r'Â¥([\d,]+)',
            r'(\d{1,3}(?:,\d{3})+)å††',
            r'ä¾¡æ ¼[ï¼š:]?\s*Â¥?([\d,]+)',
            r'(\d{1,3}(?:,\d{3})+)(?=\s*\(ç¨è¾¼\))',
        ]
        
        for pattern in price_patterns:
            match = re.search(pattern, text)
            if match:
                return f"Â¥{match.group(1)}"
        return None
    
    def parse_product_info(self, link_info):
        """ãƒªãƒ³ã‚¯æƒ…å ±ã‹ã‚‰å•†å“æƒ…å ±ã‚’æ§‹ç¯‰"""
        href = link_info['href']
        text = link_info['text']
        price_nearby = link_info['price_nearby']
        
        if href and not href.startswith('http'):
            if href.startswith('//'):
                full_link = 'https:' + href
            elif href.startswith('/'):
                full_link = 'https://www.ikebe-gakki.com' + href
            else:
                full_link = 'https://www.ikebe-gakki.com/' + href
        else:
            full_link = href
        
        product_name = text if text and len(text.strip()) > 0 else "å•†å“åä¸æ˜"
        price = price_nearby if price_nearby else "ä¾¡æ ¼ç¢ºèªä¸­"
        product_id = self.generate_product_id(product_name, full_link)
        
        return {
            'id': product_id,
            'name': product_name,
            'price': price,
            'link': full_link,
            'found_date': datetime.now().isoformat()
        }
    
    def generate_product_id(self, name, link):
        """å•†å“IDã‚’ç”Ÿæˆ"""
        if link and 'pid=' in link:
            try:
                return link.split('pid=')[1].split('&')[0]
            except:
                pass
        return str(hash(name))[:10]
    
    def is_valid_product(self, product):
        """æœ‰åŠ¹ãªå•†å“æƒ…å ±ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå³å¯†ç‰ˆï¼‰"""
        if not product or not isinstance(product, dict):
            return False
        
        name = product.get('name', '').strip()
        if not name or name == "å•†å“åä¸æ˜" or len(name) < 2:
            return False
        
        link = product.get('link', '')
        if not link or not link.startswith('http'):
            return False
        
        product_id = product.get('id', '')
        if not product_id:
            return False
        
        noise_texts = [
            'more', 'èª­ã¿è¾¼ã¿ä¸­', 'loading', '...', 'è©³ç´°', 'detail',
            'ã‚‚ã£ã¨è¦‹ã‚‹', 'view more', 'show more', 'ç¶šãã‚’è¦‹ã‚‹',
            'next', 'prev', 'previous', 'æ¬¡ã¸', 'å‰ã¸',
            'ãƒšãƒ¼ã‚¸', 'page', 'ã‚«ãƒ¼ãƒˆ', 'cart', 'ãƒ­ã‚°ã‚¤ãƒ³', 'login',
            'menu', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', 'search', 'æ¤œç´¢', 'category', 'ã‚«ãƒ†ã‚´ãƒª',
            'home', 'ãƒ›ãƒ¼ãƒ ', 'top', 'ãƒˆãƒƒãƒ—', 'back', 'æˆ»ã‚‹',
            'help', 'ãƒ˜ãƒ«ãƒ—', 'contact', 'ãŠå•ã„åˆã‚ã›',
            'unknown', 'ä¸æ˜', 'n/a', 'none', 'null'
        ]
        
        name_lower = name.lower()
        for noise in noise_texts:
            if name_lower == noise or name_lower == noise + 's':
                return False
        
        if all(c in '.,;:!?()-[]{}/*+=' for c in name.replace(' ', '')):
            return False
        
        if name.isdigit():
            return False
        
        return True
    
    def load_previous_data(self):
        """å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿"""
        try:
            if os.path.exists(self.data_file):
                with open(self.data_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                self.logger.info("ğŸ“„ åˆå›å®Ÿè¡Œã®ãŸã‚ã€å‰å›ãƒ‡ãƒ¼ã‚¿ãªã—")
                return []
        except Exception as e:
            self.logger.error(f"ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def save_data(self, products):
        """å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜"""
        try:
            with open(self.data_file, 'w', encoding='utf-8') as f:
                json.dump(products, f, indent=2, ensure_ascii=False)
            self.logger.info(f"ğŸ’¾ å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜: {len(products)}ä»¶")
        except Exception as e:
            self.logger.error(f"ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
    
    def find_new_products(self, current_products, previous_products):
        """æ–°å•†å“ã‚’æ¤œå‡º"""
        previous_ids = {p['id'] for p in previous_products}
        new_products = [p for p in current_products if p['id'] not in previous_ids]
        return new_products
    
    def send_email(self, new_products):
        """æ–°å•†å“ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥"""
        try:
            email_config = self.config['email']
            
            if not all([email_config.get('sender_email'), email_config.get('sender_password'), email_config.get('recipient_email')]):
                self.logger.error("âŒ ãƒ¡ãƒ¼ãƒ«è¨­å®šãŒä¸å®Œå…¨ã§ã™")
                return
            
            subject = f"ğŸ¸ æ–°å•†å“ãŒ{len(new_products)}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ - ã‚¤ã‚±ãƒ™æ¥½å™¨åº— [GitHub Actions]"
            
            body = f"GitHub Actionsã§è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸæ–°å•†å“ {len(new_products)}ä»¶ï¼š\n\n"
            for i, product in enumerate(new_products, 1):
                body += f"ğŸ“¦ {product['name']}\n"
                body += f"ğŸ’° {product['price']}\n"
                if product['link']:
                    body += f"ğŸ”— {product['link']}\n"
                body += "\n" + "-"*50 + "\n\n"
            
            body += f"\n\næ¤œç´¢URL: {self.url}\n"
            body += f"å®Ÿè¡Œæ™‚åˆ»: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')} (UTC)\n"
            body += f"å®Ÿè¡Œç’°å¢ƒ: GitHub Actions"
            
            msg = MIMEMultipart()
            msg['From'] = email_config['sender_email']
            msg['To'] = email_config['recipient_email']
            msg['Subject'] = subject
            
            msg.attach(MIMEText(body, 'plain', 'utf-8'))
            
            with smtplib.SMTP(email_config['smtp_server'], email_config['smtp_port']) as server:
                server.starttls()
                server.login(email_config['sender_email'], email_config['sender_password'])
                server.send_message(msg)
            
            self.logger.info(f"ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: {len(new_products)}ä»¶ã®æ–°å•†å“")
            
        except Exception as e:
            self.logger.error(f"ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
    
    def check_for_updates(self):
        """å•†å“æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯"""
        self.logger.info("ğŸ” å•†å“ãƒã‚§ãƒƒã‚¯é–‹å§‹")
        
        # ç¾åœ¨ã®å•†å“ã‚’å–å¾—
        current_products = self.get_products()
        
        if not current_products:
            self.logger.warning("âš ï¸ å•†å“ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
            return
        
        # å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        previous_products = self.load_previous_data()
        
        # æ–°å•†å“ã‚’æ¤œå‡º
        new_products = self.find_new_products(current_products, previous_products)
        
        if new_products:
            self.logger.info(f"ğŸ‰ æ–°å•†å“ã‚’{len(new_products)}ä»¶ç™ºè¦‹")
            for product in new_products:
                self.logger.info(f"  â¡ï¸ {product['name']} - {product['price']}")
            self.send_email(new_products)
        else:
            self.logger.info("â„¹ï¸ æ–°å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
        
        # ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        self.save_data(current_products)
        
        self.logger.info("âœ… å•†å“ãƒã‚§ãƒƒã‚¯å®Œäº†")
        
        # GitHub Actionsç”¨ã®ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        if os.getenv('GITHUB_ACTIONS'):
            print(f"::notice title=å•†å“ç›£è¦–å®Œäº†::ç·å•†å“æ•°: {len(current_products)}, æ–°å•†å“: {len(new_products)}")

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    try:
        monitor = GitHubMusicStoreMonitor()
        monitor.check_for_updates()
        print("ğŸ¯ ç›£è¦–å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ")
    except Exception as e:
        print(f"âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
